services:
  # --- SERVICIO PRINCIPAL: KEDRO + SPARK ---
  kedro-spark:
    build: .
    image: lomar-kedro-img
    container_name: lomar_spark_env
    ports:
      - "4040:4040" # Spark UI
      - "4141:4141" # Kedro Viz
    environment:
      - SPARK_MASTER=local[*]
      - SQL_USER=${SQL_USER}
      - SQL_PASSWORD=${SQL_PASSWORD}
      - GCP_KEY_PATH=${GCP_KEY_PATH}

    volumes:
      # Monta toda tu carpeta local
      - .:/app
      # VOLUMEN ANÃ“NIMO: Esto "oculta" tu venv local aislando la carpeta
      - /app/venv 

  # --- SERVICIO ORQUESTADOR: AIRFLOW ---
  airflow:
    image: apache/airflow:2.7.1-python3.10
    container_name: lomar_airflow_env
    command: standalone
    ports:
      - "8081:8080"
    environment:
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
    volumes:
      # SOLO mapeamos la carpeta de DAGs (Instrucciones)  
      - ./dags:/opt/airflow/dags
      # Le damos acceso al motor de Docker para que luego pueda despertar a Kedro
      - /var/run/docker.sock:/var/run/docker.sock